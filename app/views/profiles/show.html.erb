<% content_for :right_col do %>
<!-- replacement for draggggable bar -->

<% end %>

<!-- yield head -->

<h1 class="username">
  <%= @profile.user.username %>
</h1>

<h2>
  <% if @is_current_user_profile %>
  You are in your OWN profile. Can edit.
  <% else %>
  You CANNOT edit someone else's profile.
  <% end %>
</h2>
fdsfadsfsf
<%= age(@profile.birthday) %>  |


<%= PROFILE_DETAILS["sexual_orientation"][@profile["sexual_orientation"]] %>

<div class="profile-field">
  <span class="owner-can-modify" name="sex">
    <%= @profile["sex"] %>
  </span>
  <select class="form-input" name="profile[sex]">
    <option disabled selected>Choose New</option>
     <% PROFILE_DETAILS["sex"].each do |k, v| %>
       <option
         value="<%= k %>">
           <%= v %>
       </option>
     <% end %>
  </select>
</div>


<script>
$(document).ready(function() {
  $('.profile-field').on('click', '.selectable-value', function(event) {
    var $profileText = $(event.currentTarget);
    var $profileField = $(event.target).closest('.profile-field');
    $profileField.addClass("making-selection");
  });

  $('.profile-field').on('blur', '.selecting', function(e) {
    var $inputField = $(this);
    var $profileField = $(this).closest('.profile-field');
    var paramsName = $(this).attr("name");
    var paramsValue = $(this).val();
    var replacingText =
      this.options[e.target.selectedIndex].text;

    if (replacingText != "Choose new") {
    var formData = $(this).serializeJSON();
    var $that = $(this);

    $.ajax({
            url: "<%= profile_url(@profile.id) %>", //will cause trouble?
            type: "PUT",
            data: formData,
            dataType: "json",
            success: function (response) {
              var $profileText = $that.siblings('.selectable-value');

              //change value of inside span.
              $profileText.html(replacingText);
              $profileField
                .removeClass("making-selection");
            },
            error: function(response) {
              console.log("error");
            }
          });

        } else {
          $profileField
            .removeClass("making-selection");
        }




    //if not disabled!
    //var $profileText = $(event.currentTarget);
    //var $profileField = $(event.target).closest('.profile-field');
    //$profileField.toggleClass("making-selection");




  });


});
</script>


 |


<div class="profile-field"><span name="city"><%= @profile.city %>
  but modifying zip code.
<br>

<% unless @is_current_user_profile %>
  <% percentages = current_user.calculate_percentages(@profile.user) %>
  <%= print_percentages(percentages) %>
<% end %>
<br>

<%= image_tag(@profile.big_photo.url, :class => "photo-thumbnail") if @profile
  .big_photo.exists? %>
<%= image_tag(@profile.big_photo.url, :class => "photo-thumbnail") if
@profile.big_photo.exists? %>
<br>
<%# height later %>





<% unless @is_current_user_profile %>
  <% if current_user.likes?(@profile.user) %>
    	<% if @profile.user.likes?(current_user) %>
      	<b> You guys both like each other!</b>
    	<% else %>
      	<b> You've liked this user already. Let's hope they like you back. </b>
    	<% end %>
  <% else %>
    <br>
    <%= button_to "Like User", like_user_url(@profile.user_id), {method: :post} %>
    <div class="">
      <input
        type="submit"
          class="message"
            value="MESSAGE A BROTHA">
    </div>
  <% end %>
<% end %>


<h2>Bio</h2>
<div class="profile-field">
  <span class="owner-can-modify" name="description">
    <%= @profile.description %>
  </span>
  <textarea class="form-input" name="profile[description]"></textarea>
</div>

<h2>Loves</h2>

<%= @profile["likes"] %>

<h2> Details</h2>
<table class="profile-stats">
  <% TABULAR_DETAILS.keys.each do |key| %>
  <tr>
    <th><%= key.gsub(/_/," ").capitalize %></th>
    <td>
    <div class="profile-field">
    <span class="owner-can-modify" name="<%= key %>">
      <%= unless @profile[key].nil?
        PROFILE_DETAILS[key][@profile[key]]
      else
        "-" end %>
        </span>
        <select class="form-input" name="profile[<%= key %>]">
        <option disabled selected>Choose new</option>
        <% PROFILE_DETAILS[key].each do |k, v| %>
          <option
            value="<%= k %>">
              <%= v %>
          </option>
        <% end %>


        </select>
        </div>
    </td>
  </tr>
  <% end %>
</table>




<% if @is_current_user_profile %>
<script type="text/javascript">
$(document).ready(function() {
  $('.profile-field').on('click', '.owner-can-modify', function(e) {
    var $profileText = $(this);
    var $profileField = $(this).closest('.profile-field');
    var $input = $profileField.find('.form-input')

    if ($input.is('textarea')) {
      $input.html($(this).html());
    };
    //regular text input too.
    $profileField.addClass('modifying');
  });

  //set name in there!
  $('.profile-field').on('blur', '.form-input', function(e) {
    var $input = $(this);
    var $profileField = $input.closest('.profile-field');
    var $profileText = $profileField.find('.owner-can-modify');
    var formData = $(this).serializeJSON();

    var newValue;
    if ($input.is('select')) {
      newValue = this.options[e.target.selectedIndex].text;

      if (newValue === "Choose new") {
        $profileField.removeClass('modifying');
        return;
      };

    } else {
      newValue = $input.val();
    };
    // var newValue = $(this).;

    //if its not a select with text Choose New
    $.ajax({
      url: "<%= profile_url(@profile.id) %>",
      type: "PUT",
      data: formData,
      dataType: "json",
      success: function(r) {
        alert("Great!");
        $profileText.html(newValue);
        $profileField.removeClass('modifying');
      },
      error: function(r) {
        alert("Error");
      }
    });


  });

});
</script>





<% else %>
<script>
$(document).ready(function() {

  $('.send-message').on('submit',function(event) {
    event.preventDefault();

    var formData = $(this).serializeJSON();
    console.log("<%= user_messages_url(@profile.user.id) %>");
    console.log("Right before ajax call");
    console.log(formData);
    console.log(this);
    $.ajax({
            url: "<%= user_messages_url(@profile.user.id) %>", //will cause trouble?
            type: "POST",
            data: formData,
            dataType: "json",
            success: function (response) {
              console.log(response);
              console.log("Your callback here!");
              $('.hide-container').toggleClass("unhide");
            },
            error: function(response) {
              console.log("error");
              console.log(response);
            }
          });



  });


  $( ".message" ).click(function(event) {
    event.preventDefault();
    $('.hide-container').toggleClass("unhide");
  });


});
</script>

<script>
$( ".send-message" ).draggable({
  containment: $('content'),
  stop: function(event, ui) {
    console.log(event);
    console.log(ui);
  }
});
</script>


<% end %>











<h2>Questions:</h2>

<% if @is_current_user_profile %>
Need to do for current user!!




<% else %>

<%= "This person has not answered any questions." if @other_user_responses.length == 0 %>

<% @other_user_responses.each do |other_response| %>
<p>
<%= other_response.question_text %><br>

<% current_user_response = find_response(other_response.question_id, @current_user_responses) %>

<% if current_user_response.nil? %>

Answer question <%= other_response.question_id %> to see their answer.

<% else %>


<%= (@profile["sex"] == "Male") ? "His" : "Her" %> response: <span class="<%= "unacceptable-resp" if is_unacceptable?(other_response, @current_user_acceptables) %>"><%= other_response.answer_text%> </span>
<br>
Your response:

<span class="<%= "unacceptable-resp" if is_unacceptable?(current_user_response, @other_user_acceptables) %>"><%= current_user_response.answer_text %></span>

<% end %>

<% end %>

<% end %>

<div class="hide-container">

<form class="send-message">
  <%= auth_token_input %>
  <textarea name="message[body]">Type some stuff here</textarea>
  <input type="submit" class="submit-message" value="Submit or close">

</form>

</div>

<br>



